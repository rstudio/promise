<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Do not block main R session with `future`. A `plumber` example • promises</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.4.0/cosmo/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Do not block main R session with `future`. A `plumber` example">
<meta property="og:description" content="promises">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-inverse navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">promises</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">1.1.1.9001</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fas fa-home"></span>
     
    Home
  </a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Learning
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/motivation.html">1. Why use promises?</a>
    </li>
    <li>
      <a href="../articles/intro.html">2. An informal intro to async programming</a>
    </li>
    <li>
      <a href="../articles/overview.html">3. Working with promises</a>
    </li>
    <li>
      <a href="../articles/futures.html">4. Launching tasks with future</a>
    </li>
    <li>
      <a href="../articles/future_promise.html">5. Advanced future and promise usage</a>
    </li>
    <li>
      <a href="../articles/shiny.html">6. Using promises with Shiny</a>
    </li>
    <li>
      <a href="../articles/combining.html">7. Combining promises</a>
    </li>
    <li>
      <a href="../articles/casestudy.html">8. Case study: Converting a Shiny app to async</a>
    </li>
  </ul>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/rstudio/promises/">
    <span class="fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><script src="future_promise_files/header-attrs-2.6/header-attrs.js"></script><script src="future_promise_files/accessible-code-block-0.0.1/empty-anchor.js"></script><link href="future_promise_files/vembedr-0.1.4/css/vembedr.css" rel="stylesheet">
<div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Do not block main R session with <code>future</code>. A <code>plumber</code> example</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/rstudio/promises/blob/master/vignettes/future_promise.Rmd"><code>vignettes/future_promise.Rmd</code></a></small>
      <div class="hidden name"><code>future_promise.Rmd</code></div>

    </div>

    
    
<p>Be sure you are comfortable with the main concepts in <a href="future.html">Launching tasks with future</a>.</p>
<hr>
<p>When using <code>future</code> package, the result of <code><a href="https://rdrr.io/pkg/future/man/future.html">future::future()</a></code> can be upgraded to a <code>promise</code> object by using the promise pipe (<code><a href="../reference/pipes.html">%...&gt;%</a></code>). For example:</p>
<div class="sourceCode" id="cb1"><pre class="downlit">
<span class="kw">prom_1</span> <span class="op">&lt;-</span>
  <span class="kw">future</span>::<span class="fu"><a href="https://rdrr.io/pkg/future/man/future.html">future</a></span>({ <span class="fu">expensive_operation</span>() }) <span class="op">%...&gt;%</span>
  <span class="fu">local_promise_operation</span>()</pre></div>
<p>Since the release of <a href="https://www.rplumber.io/"><code>plumber</code></a> v1.0.0, <code>plumber</code> allows for routes to return a <em>promising</em> object and will wait until the <em>promising</em> object is resolved before continuing with the route execution. <code>plumber</code> checks for <em>promising</em> objects using <code>promises::is_promising()</code>, which returns <code>TRUE</code> for both <code><a href="../reference/promise.html">promises::promise()</a></code> and <code><a href="https://rdrr.io/pkg/future/man/future.html">future::future()</a></code> objects.</p>
<p>In both cases, the result of the promising object is executed in a followup promise. <code>promises</code> are built on top of <code>later</code>, which only execute when the main R session is <em>free</em>. These are <strong>key</strong> bits of information for the remainder of the document.</p>
<p>Note: The same benefits of using <code><a href="../reference/future_promise_queue.html">future_promise()</a></code> within <code>plumber</code> would also apply to using <code><a href="../reference/future_promise_queue.html">future_promise()</a></code> with any other R package, such as <code>shiny</code>.</p>
<div id="futurefuture" class="section level2">
<h2 class="hasAnchor">
<a href="#futurefuture" class="anchor"></a><code>future::future()</code>
</h2>
<p>In an ideal situation, the number of free <code>future</code> (&gt;= 1.21.0) workers (<code><a href="https://rdrr.io/pkg/future/man/nbrOfWorkers.html">future::nbrOfFreeWorkers()</a></code>) is always less than the number of <code><a href="https://rdrr.io/pkg/future/man/future.html">future::future()</a></code> requests. If the number of <code>future</code> request is executed when the number of free workers is <code>0</code>, then the main R session is blocked until a worker becomes available.</p>
<p>Let’s set up an example of seven <code>plumber</code> requests being received at the same time. The first six requests will be processed using <code><a href="https://rdrr.io/pkg/future/man/future.html">future::future()</a></code> and the final request will be processed in the main R session. The trailing number at the end of each request is the request’s arrival order. Assuming the <code>future</code> work takes ~10s to compute, the execution timeline would look like:</p>
<div class="figure">
<img src="future_promise/future.png" alt=""><p class="caption">Early workers take more time than expected. Main R session is blocked</p>
</div>
<p>While the overall time is faster than if the requests were serially executed, the turn around time for earlier routes (e.g. <code>/slow/1</code>) will be much longer. This is becuase the main R session is blocked. Blocking the main R session prevents * any remaining <code>plumber</code> requests from being processed * any pending <code>promises</code> objects (or <code>later</code> callbacks) from being executed, such as responding to a route executed by <code>future</code>.</p>
<div class="figure">
<img src="future_promise/blocked_future.png" alt=""><p class="caption">future does not respond to anything until the main R session is <em>free</em></p>
</div>
<p>Let’s look at how this example might play out with the example being executed (with timing altered to allow for animations):</p>
<div class="vembedr" align="center">
<div>
<iframe class="vimeo-embed" src="https://player.vimeo.com/video/505287449" width="533" height="300" frameborder="0" webkitallowfullscreen="" mozallowfullscreen="" allowfullscreen=""></iframe>
</div>
</div>
</div>
<div id="future_promise" class="section level2">
<h2 class="hasAnchor">
<a href="#future_promise" class="anchor"></a><code>future_promise()</code>
</h2>
<p><code><a href="../reference/future_promise_queue.html">future_promise()</a></code> is a <em>promise</em> to execute the expression using <code><a href="https://rdrr.io/pkg/future/man/future.html">future::future()</a></code> and returns a <code><a href="../reference/promise.html">promises::promise()</a></code>, rather than the original <code><a href="https://rdrr.io/pkg/future/man/future.html">future::future()</a></code> object. <code><a href="../reference/future_promise_queue.html">future_promise()</a></code> will resolve to the final value of the execution of <code><a href="https://rdrr.io/pkg/future/man/future.html">future::future()</a></code>.</p>
<p>The advantage of <code><a href="../reference/future_promise_queue.html">future_promise()</a></code> is that it will not submit <code>future</code> work unless a <code>future</code> worker is available. This keeps the main R session available as much as possible.</p>
<p>Looking at our example below, the <code>/fast/7</code> route will not have to wait for any <code>future</code> work to finish processing. Only the times where the main R session was blocked was the initial requests submissions, creating the <code><a href="../reference/future_promise_queue.html">future_promise()</a></code> promises, and resolving the <code><a href="../reference/future_promise_queue.html">future_promise()</a></code> response.</p>
<div class="figure">
<img src="future_promise/blocked_future_promise.png" alt=""><p class="caption">future_promise() keeps the main R session free</p>
</div>
<p>And again with an animation (with timing altered to allow for animations):</p>
<div class="vembedr" align="center">
<div>
<iframe class="vimeo-embed" src="https://player.vimeo.com/video/505286442" width="533" height="300" frameborder="0" webkitallowfullscreen="" mozallowfullscreen="" allowfullscreen=""></iframe>
</div>
</div>
</div>
<div id="variable-scope-in-future_promise-and-futurefuture" class="section level2">
<h2 class="hasAnchor">
<a href="#variable-scope-in-future_promise-and-futurefuture" class="anchor"></a>Variable scope in <code>future_promise()</code> and <code>future::future()</code>
</h2>
<p><code><a href="../reference/future_promise_queue.html">future_promise()</a></code> is a promise <strong>first</strong> and executes using <code><a href="https://rdrr.io/pkg/future/man/future.html">future::future()</a></code> <strong>second</strong>. <code><a href="../reference/future_promise_queue.html">future_promise()</a></code> should use the same precautions that you would use with a regular <code><a href="../reference/promise.html">promises::promise()</a></code>.</p>
<p>With <code>future</code> blocking on the main R session, this prevents values from being changed before they are submitted to the external worker. While a promise waits to be executed, it is known that variables that have not been forced or properly scoped can change from their expected values before evaluation occurs. This can also occur with properly scoped environment values as only the <em>pointer</em> to the environment is static. This allows for the values within the environment to be altered before the promise is executed.</p>
<div id="scope" class="section level4">
<h4 class="hasAnchor">
<a href="#scope" class="anchor"></a>Scope</h4>
<p>In the example below, the variable <code>i</code> is not forced to a specific value for the promise. With the promise resolving within the global environment, the latest <code>i</code> value will be used for all of the promises waiting to resolve.</p>
<div class="sourceCode" id="cb2"><pre class="downlit">
<span class="kw">items</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span>()
<span class="co">for</span> (<span class="kw">i</span> <span class="co">in</span> <span class="fl">1</span><span class="op">:</span><span class="fl">10</span>) {
  <span class="kw">items</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="kw">items</span>, <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span>(
    <span class="fu"><a href="../reference/promise_resolve.html">promise_resolve</a></span>(<span class="fl">TRUE</span>) <span class="op">%...&gt;%</span> {<span class="kw">i</span>}
  ))
}
<span class="fu"><a href="../reference/promise_all.html">promise_all</a></span>(.list = <span class="kw">items</span>) <span class="op">%...&gt;%</span>
  { <span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/unlist.html">unlist</a></span>(<span class="kw">.</span>)) }
<span class="co"># #&gt; [1] 10 10 10 10 10 10 10 10 10 10</span></pre></div>
<p>To combat variable scoping issues, functions can be used to create local environments that will <em>scope</em> the expected <code>i</code> value.</p>
<div class="sourceCode" id="cb3"><pre class="downlit">
<span class="fu"><a href="https://rdrr.io/r/base/lapply.html">lapply</a></span>(<span class="fl">1</span><span class="op">:</span><span class="fl">10</span>, <span class="fu">function</span>(<span class="kw">i</span>) {
  <span class="fu"><a href="../reference/promise_resolve.html">promise_resolve</a></span>(<span class="fl">TRUE</span>) <span class="op">%...&gt;%</span> {<span class="kw">i</span>}
}) <span class="op">%&gt;%</span>
  <span class="fu"><a href="../reference/promise_all.html">promise_all</a></span>(.list = <span class="kw">.</span>) <span class="op">%...&gt;%</span>
  { <span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/unlist.html">unlist</a></span>(<span class="kw">.</span>)) }
<span class="co">#&gt; [1]  1  2  3  4  5  6  7  8  9 10</span></pre></div>
</div>
<div id="changing-environments" class="section level4">
<h4 class="hasAnchor">
<a href="#changing-environments" class="anchor"></a>Changing environments</h4>
<p>Environments can have their values changed after the original promise creation. This can cause unexpected behavior when evaluating a promise.</p>
<p>For example, the environment <code>env</code> below will have its value <code>a</code> changed from <code>1</code> to <code>2</code> before the promise is resolved. This causes the unexpected value of <code>2</code> to be returned in the promise.</p>
<div class="sourceCode" id="cb4"><pre class="downlit">
{
  <span class="kw">env</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/environment.html">new.env</a></span>()
  <span class="kw">env</span><span class="op">$</span><span class="kw">a</span> <span class="op">&lt;-</span> <span class="fl">1</span>

  <span class="fu"><a href="../reference/promise_resolve.html">promise_resolve</a></span>(<span class="fl">TRUE</span>) <span class="op">%...&gt;%</span>
    { <span class="fu"><a href="https://rdrr.io/r/base/Sys.sleep.html">Sys.sleep</a></span>(<span class="fl">1</span>); <span class="kw">env</span><span class="op">$</span><span class="kw">a</span> } <span class="op">%...&gt;%</span>
    { <span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span>(<span class="kw">.</span>) }
  <span class="kw">env</span><span class="op">$</span><span class="kw">a</span> <span class="op">&lt;-</span> <span class="fl">2</span>
  <span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span>(<span class="st">"Changed env$a"</span>)
}
<span class="co">#&gt; [1] "Changed env$a"</span>
<span class="co">#&gt; [1] 2</span></pre></div>
<p>To address lazy evaluation and environment variable issues, we can store the values to a local variable and force their evaluation.</p>
<p>Fixing the example, we can capture the value <code>a</code> (or turn the environment into a <code><a href="https://rdrr.io/r/base/list.html">list()</a></code>).</p>
<div class="sourceCode" id="cb5"><pre class="downlit">
{
  <span class="kw">env</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/environment.html">new.env</a></span>()
  <span class="kw">env</span><span class="op">$</span><span class="kw">a</span> <span class="op">&lt;-</span> <span class="fl">1</span>

  <span class="kw">a_value</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/force.html">force</a></span>(<span class="kw">env</span><span class="op">$</span><span class="kw">a</span>)
  <span class="fu"><a href="../reference/promise_resolve.html">promise_resolve</a></span>(<span class="fl">TRUE</span>) <span class="op">%...&gt;%</span>
    { <span class="fu"><a href="https://rdrr.io/r/base/Sys.sleep.html">Sys.sleep</a></span>(<span class="fl">1</span>); <span class="kw">a_value</span> } <span class="op">%...&gt;%</span>
    { <span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span>(<span class="kw">.</span>) }
  <span class="kw">env</span><span class="op">$</span><span class="kw">a</span> <span class="op">&lt;-</span> <span class="fl">2</span>
  <span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span>(<span class="st">"done"</span>)
}
<span class="co">#&gt; [1] "done"</span>
<span class="co">#&gt; [1] 1</span></pre></div>
<p>The expression in <code><a href="../reference/future_promise_queue.html">future_promise(expr)</a></code> will behave like a promise and should have its volitile variables scoped and <code><a href="https://rdrr.io/r/base/force.html">force()</a></code>ed to achieve similar evaluations when using <code><a href="https://rdrr.io/pkg/future/man/future.html">future::future()</a></code> directly.</p>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p>Developed by Joe Cheng, <a href="https://www.rstudio.com"><img src="https://tidyverse.org/rstudio-logo.svg" height="24"></a>.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.6.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
